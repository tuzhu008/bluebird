<p>For development tasks such as contributing, running benchmarks or testing, you need to clone the repository and install dev-dependencies.</p>

<p>Install <a href="http://nodejs.org/">node</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git@github.com:petkaantonov/bluebird.git
cd bluebird
npm install
</code></pre></div></div>

<ul>
  <li><a href="#directory-structure">Directory structure</a></li>
  <li><a href="#style-guide">Style guide</a></li>
  <li><a href="#building">Building</a>
    <ul>
      <li><a href="#supported-options-by-the-build-tool">Supported options by the build tool</a></li>
    </ul>
  </li>
  <li><a href="#testing">Testing</a>
    <ul>
      <li><a href="#testing-in-browsers">Testing in browsers</a></li>
      <li><a href="#supported-options-by-the-test-tool">Supported options by the test tool</a></li>
    </ul>
  </li>
  <li><a href="#benchmarking">Benchmarking</a></li>
</ul>

<h2 id="directory-structure">Directory structure</h2>

<ul>
  <li>
    <p><code class="highlighter-rouge">/benchmark</code> contains benchmark scripts and stats of benchmarks</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">/tools</code> contains building and testing tools and scripts</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">/src</code> contains the source code</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">/test</code> contains test code</p>

    <ul>
      <li><code class="highlighter-rouge">/test/mocha</code> contains tests using the mocha testing framework</li>
      <li><code class="highlighter-rouge">/test/browser</code> a directory that can be statically served using a webserver to run tests in browsers. See <a href="README.md#testing-in-browsers">testing in browsers</a>.</li>
    </ul>
  </li>
</ul>

<h2 id="style-guide">Style guide</h2>

<p>Use the same style as is used in the surrounding code.</p>

<p>###Whitespace</p>

<ul>
  <li>No more than 80 columns per line</li>
  <li>4 space indentation</li>
  <li>No trailing whitespace</li>
  <li>LF at end of files</li>
  <li>Curly braces can be left out of single statement <code class="highlighter-rouge">if/else/else if</code>s when it is obvious there will never be multiple statements such as null check at the top of a function for an early return.</li>
  <li>Add an additional new line between logical sections of code.</li>
</ul>

<p>###Variables</p>

<ul>
  <li>Use multiple <code class="highlighter-rouge">var</code> statements instead of a single one with comma separator. Do not declare variables until you need them.</li>
</ul>

<p>###Equality and type checks</p>

<ul>
  <li>Always use <code class="highlighter-rouge">===</code> except when checking for null or undefined. To check for null or undefined, use <code class="highlighter-rouge">x == null</code>.</li>
  <li>For checks that can be done with <code class="highlighter-rouge">typeof</code>: do not make helper functions, save results of <code class="highlighter-rouge">typeof</code> to a variable or make the type string a non-constant. Always write the check in the form <code class="highlighter-rouge">typeof expression === "constant string"</code> even if it feels like repeating yourself.</li>
</ul>

<p>##Building</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node tools/build --debug --release --zalgo --browser --minify
</code></pre></div></div>

<p>###Supported options by the build tool</p>

<p>The value of boolean flags is determined by presence, if you want to pass false value for a boolean flag, use the <code class="highlighter-rouge">no-</code>-prefix e.g. <code class="highlighter-rouge">--no-debug</code>.</p>

<ul>
  <li><code class="highlighter-rouge">--release</code> - Whether to build the release build. The release build is placed at <code class="highlighter-rouge">js/release</code> directory. Default <code class="highlighter-rouge">false</code>.</li>
  <li><code class="highlighter-rouge">--debug</code> - Whether to build the debug build. The debug build is placed at <code class="highlighter-rouge">js/debug</code> directory. Default <code class="highlighter-rouge">false</code>.</li>
  <li><code class="highlighter-rouge">--zalgo</code> - Whether to build the zalgo build. The zalgo build is placed at <code class="highlighter-rouge">js/zalgo</code> directory. Default <code class="highlighter-rouge">false</code>.</li>
  <li><code class="highlighter-rouge">--browser</code> - Whether to compile the browser build. The browser build file is placed at <code class="highlighter-rouge">js/browser/bluebird.js</code> Default <code class="highlighter-rouge">false</code>.</li>
  <li><code class="highlighter-rouge">--minify</code> - Whether to minify the compiled browser build. The minified browser build file is placed at <code class="highlighter-rouge">js/browser/bluebird.min.js</code> Default <code class="highlighter-rouge">true</code>.</li>
</ul>

<p>##Testing</p>

<p>To run all tests, run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node tools/test
</code></pre></div></div>

<p>If you need to run generator tests in older versions of NodeJS run the <code class="highlighter-rouge">tool/test.js</code> script with <code class="highlighter-rouge">--harmony</code> argument and 0.11+:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node-dev --harmony tools/test
</code></pre></div></div>

<p>In recent versions of NodeJS where generators are enabled by default:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node tools/test
</code></pre></div></div>

<p>You may specify an individual test file to run with the <code class="highlighter-rouge">--run</code> script flag:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node tools/test --run=cancel.js
</code></pre></div></div>

<p>This enables output from the test and may give a better idea where the test is failing. The paramter to <code class="highlighter-rouge">--run</code> can be any file name located in <code class="highlighter-rouge">test/mocha</code> folder.</p>

<p>###Testing in browsers</p>

<p>To run the test in a browser instead of node, pass the flag <code class="highlighter-rouge">--browser</code> to the test tool</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node tools/test --run=cancel.js --browser
</code></pre></div></div>

<p>This will automatically create a server (default port 9999) and open it in your default browser once the tests have been compiled.</p>

<p>Keep the test tab active because some tests are timing-sensitive and will fail if the browser is throttling timeouts. Chrome will do this for example when the tab is not active.</p>

<p>###Supported options by the test tool</p>

<p>The value of boolean flags is determined by presence, if you want to pass false value for a boolean flag, use the <code class="highlighter-rouge">no-</code>-prefix e.g. <code class="highlighter-rouge">--no-browser</code>.</p>

<ul>
  <li><code class="highlighter-rouge">--run=String</code>. Which tests to run (or compile when testing in browser). Default <code class="highlighter-rouge">"all"</code>. Can also be a glob string (relative to ./test/mocha folder)</li>
  <li><code class="highlighter-rouge">--cover=String</code>. Create code coverage using the String as istanbul reporter. Coverage is created in the ./coverage folder. No coverage is created by default, default reporter is <code class="highlighter-rouge">"html"</code> (use <code class="highlighter-rouge">--cover</code> to use default reporter).</li>
  <li><code class="highlighter-rouge">--browser</code> - Whether to compile tests for browsers. Default <code class="highlighter-rouge">false</code>.</li>
  <li><code class="highlighter-rouge">--port=Number</code> - Whe port where local server is hosted when testing in browser. Default <code class="highlighter-rouge">9999</code></li>
  <li><code class="highlighter-rouge">--execute-browser-tests</code> - Whether to execute the compiled tests for browser when using <code class="highlighter-rouge">--browser</code>. Default <code class="highlighter-rouge">true</code>.</li>
  <li><code class="highlighter-rouge">--open-browser</code> - Whether to open the default browser when executing browser tests. Default <code class="highlighter-rouge">true</code>.</li>
  <li><code class="highlighter-rouge">--fake-timers</code> - Whether to use fake timers (<code class="highlighter-rouge">setTimeout</code> etc) when running tests in node. Default <code class="highlighter-rouge">true</code>.</li>
  <li><code class="highlighter-rouge">--js-hint</code> - Whether to run JSHint on source files. Default <code class="highlighter-rouge">true</code>.</li>
  <li><code class="highlighter-rouge">--saucelabs</code> Wheter to create a tunnel to sauce labs and run tests in their VMs instead of your browser when compiling tests for browser.Default <code class="highlighter-rouge">false</code>.</li>
</ul>

<p>##Benchmarking</p>

<p>To run a benchmark, run the given command for a benchmark while on the project root. Requires bash (on windows the mingw32 that comes with git works fine too).</p>

<p>Each benchmark must</p>

<ul>
  <li>Have implementations that do the same thing</li>
  <li>Run each implementation of a benchmark in a separate freshly created process</li>
  <li>Warmup each implementation before timing</li>
</ul>

<p>###1. DoxBee sequential</p>

<p>Currently the most relevant benchmark is @gorkikosevâ€™s benchmark in the article <a href="http://spion.github.io/posts/analysis-generators-and-other-async-patterns-node.html">Analysis of generators and other async patterns in node</a>. The benchmark emulates a situation where n amount of users are making a request in parallel to execute some mixed async/sync action.</p>

<p>Command: <code class="highlighter-rouge">bench doxbee</code></p>

<p>The implementations for this benchmark are found in <code class="highlighter-rouge">benchmark/doxbee-sequential</code> directory.</p>

<p>###2. Parallel</p>

<p>This made-up scenario runs 25 shimmed queries in parallel.</p>

<p>Command: <code class="highlighter-rouge">bench parallel</code></p>

<p>The implementations for this benchmark are found in <code class="highlighter-rouge">benchmark/madeup-parallel</code> directory.</p>
