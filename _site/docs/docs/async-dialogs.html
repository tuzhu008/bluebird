<p><a href="unfinished-article">async-dialogs</a></p>

<p>Typically <em>promises</em> are used in conjunction with asynchronous tasks such as a
network request or a <code class="highlighter-rouge">setTimeout</code>; a lesser explored use is dealing with user
input. Since a program has to wait for a user to continue some actions it makes
sense to consider it an asynchronous event.</p>

<p>For comparison I’ll start with an example of a <em>synchronous</em> user interaction
using <code class="highlighter-rouge">window.prompt</code> and then move to an <em>asynchronous</em> interaction by making
our own DOM based prompt. To begin, here is a template for a simple HTML page:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>Async Dislogs Example<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"//cdn.jsdelivr.net/bluebird//bluebird.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'DOMContentLoaded'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'time-stamp'</span><span class="p">);</span>
      <span class="nx">clockTick</span><span class="p">();</span>
      <span class="nx">setInterval</span><span class="p">(</span><span class="nx">clockTick</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">clockTick</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toLocaleTimeString</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;p&gt;</span>The current time is <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"time-stamp"</span><span class="nt">&gt;&lt;/span&gt;</span>.<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>Your name is <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"prompt"</span><span class="nt">&gt;&lt;/span&gt;</span>.<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"action"</span><span class="nt">&gt;</span>Set Name<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">window.prompt</code> blocks the web page from processing while it waits for the user
to enter in data. It has to block because the input is returned and the next
line of code needs that result. But for sake of this tutorial we are going to
convert the typical conditional code into a promise API using a <a href="api/new-promise.html">promise
constructor</a>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">promptPromise</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">prompt</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'User cancelled'</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'action'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'prompt'</span><span class="p">);</span>

<span class="nx">button</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">promptPromise</span><span class="p">(</span><span class="s1">'What is your name?'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">output</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">output</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'¯</span><span class="err">\\</span><span class="s1">_(ツ)_/¯'</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p><a href="http://jsbin.com/kowama/edit?js,output">Run example on JSBin</a></p>

<p>This doesn’t add much much using <code class="highlighter-rouge">window.prompt</code>; however, one advantage is the
API that promises provide. In the case where we call <code class="highlighter-rouge">promptPromise(…)</code> we can
easily react to the result of the dialog without having to worry about how it is
implemented. In our example we’ve implemented the <code class="highlighter-rouge">window.prompt</code> but our call
to <code class="highlighter-rouge">promptPromise()</code> doesn’t care. This makes a change to an <em>asynchronous</em>
dialog a little more future proof.</p>

<p>To drive home the synchronous nature of the <code class="highlighter-rouge">window.prompt</code> notice that the time
stops ticking when the prompt dialog is displayed. Let’s fix that by making our
own prompt. Since our dialog is just DOM manipulation the page won’t be blocked
while waiting for user input.</p>

<p>First add the prompt dialog to the HTML:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;style </span><span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
  <span class="nf">#dialog</span> <span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span>      <span class="m">200px</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span>     <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span>    <span class="m">10px</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span>     <span class="nb">thin</span> <span class="nb">solid</span> <span class="no">black</span><span class="p">;</span>
    <span class="nl">background</span><span class="p">:</span> <span class="no">lightgreen</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nc">.hidden</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"dialog"</span> <span class="na">class=</span><span class="s">"hidden"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"message"</span><span class="nt">&gt;</span>foobar<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"ok"</span><span class="nt">&gt;</span>Ok<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"cancel"</span><span class="nt">&gt;</span>Cancel<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>We will want to keep the same API so our change will be only to the
<code class="highlighter-rouge">promisePrompt</code>. It will find the dialog DOM elements, attach events to the
elements, show the dialog box, return a promise that is resolved based on the
attached events, and finally detaches the events and cleans up after itself
(hiding the dialog box for another use later).</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">promptPromise</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dialog</span>       <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'dialog'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">input</span>        <span class="o">=</span> <span class="nx">dialog</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">okButton</span>     <span class="o">=</span> <span class="nx">dialog</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'button.ok'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">cancelButton</span> <span class="o">=</span> <span class="nx">dialog</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'button.cancel'</span><span class="p">);</span>

  <span class="nx">dialog</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'.message'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="nx">dialog</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dialog</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">handleButtonClicks</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">!==</span> <span class="s1">'BUTTON'</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
      <span class="nx">dialog</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">handleButtonClicks</span><span class="p">);</span>
      <span class="nx">dialog</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">'hidden'</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="o">===</span> <span class="nx">okButton</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'User cancelled'</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="http://jsbin.com/fucofu/edit?js,output">Run example on JSBin</a></p>

<p>Now when the user presses the <strong>Set Name</strong> button the clock continues to update
while the dialog is visible.</p>

<p>Because the <code class="highlighter-rouge">removeEventListener</code> requires a reference to the original function
that was used with the <code class="highlighter-rouge">addEventListener</code> it makes it difficult to clean up
after itself without storing the references in a scope higher then the handler
itself. Using a named function we can reference it when a user clicks the
button. To help with performance and to avoid duplicating code the example uses
<a href="https://davidwalsh.name/event-delegate">event delegation</a> to capture both buttons in one <em>click</em> handler.</p>

<p>The same thing can be done with less code using jQuery’s <a href="https://api.jquery.com/on/#event-names">event
namespacing</a>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#okButton'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click.promptDialog'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#cancelButton'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click.promptDialog'</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#okButton'</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">'click.promptDialog'</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#cancelButton'</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">'click.promptDialog'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>There are still a few problems with the earlier code example. It feels like it
is doing too much. A <em>squint</em> test reveals behavior for showing the dialog, set
the dialog’s message, attach two DOM events, construct a promise, event
delegation, hide the dialog, and finally detach DOM events. That is a lot for
one little function. A refactoring can help.</p>

<p>Abstraction is the key here. We will make an <em>object</em> (or class) that is
responsible for managing the dialog box. Its interface will manage only two
function references (callbacks): when the user clicks ok and when user clicks
cancel. And it will offer the value when asked.</p>

<p>Using an abstraction like this the <code class="highlighter-rouge">promisePrompt</code> no longer needs to know
anything about the DOM and concentrates on just providing a promise. This will
also make things easier to create a promised version of a progress bar or
confirmation dialog or any other type of UI that we want to have a value for.
All we will need to do is write a class for that dialog type with the same
interface and just pass that class into our promise making method.</p>

<p>The dialog interface might look like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">noop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">Dialog</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setCallbacks</span><span class="p">(</span><span class="nx">noop</span><span class="p">,</span> <span class="nx">noop</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setCallbacks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">okCallback</span><span class="p">,</span> <span class="nx">cancelCallback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_okCallback</span>     <span class="o">=</span> <span class="nx">okCallback</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cancelCallback</span> <span class="o">=</span> <span class="nx">cancelCallback</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">Dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">waitForUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">setCallbacks</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">Dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="nx">noop</span><span class="p">;</span>
<span class="nx">Dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="nx">noop</span><span class="p">;</span>
</code></pre></div></div>

<p>Initially the Dialog class sets the two callbacks to <em>noop</em> functions. It is up
to the child class to call them when necessary. We break down the promise
creation to one function <code class="highlighter-rouge">waitForUser()</code> that sets the callbacks and returns a
promise. At this level the <code class="highlighter-rouge">show()</code> and <code class="highlighter-rouge">hide()</code> are just <em>noop</em> functions as
well and will be implemented by the child classes.</p>

<p>Our <code class="highlighter-rouge">PromptDialog</code> class is responsible for inheriting from <code class="highlighter-rouge">Dialog</code> and setting
up the required DOM scaffolding and eventually call <code class="highlighter-rouge">this._okCallback</code> or
<code class="highlighter-rouge">this._cancelCallback</code> as appropriate.</p>

<p>It might look like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">PromptDialog</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Dialog</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span>           <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'dialog'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">inputEl</span>      <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">messageEl</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'.message'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">okButton</span>     <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'button.ok'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cancelButton</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'button.cancel'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">attachDomEvents</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">PromptDialog</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nx">PromptDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">attachDomEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">okButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">_okCallback</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">inputEl</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cancelButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">_cancelCallback</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">PromptDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">messageEl</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">PromptDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">'hidden'</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Notice that use of <code class="highlighter-rouge">return this;</code> in most of the functions? That pattern will
allow method chaining as you’ll see shortly.</p>

<p>This inherits from <code class="highlighter-rouge">Dialog</code> and stores references to the required DOM elements
that this dialog uses. It then attaches the require DOM events
(<code class="highlighter-rouge">attachDomEvents()</code>) which eventually call the callbacks. Then it implements
the <code class="highlighter-rouge">show()</code> and <code class="highlighter-rouge">hide()</code> methods. Its usage is more flexible and verbose:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'prompt'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">prompt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PromptDialog</span><span class="p">();</span>

<span class="nx">prompt</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="s1">'What is your name?'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">waitForUser</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'¯</span><span class="err">\\</span><span class="s1">_(ツ)_/¯'</span><span class="p">;</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">prompt</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
  <span class="p">});</span>
</code></pre></div></div>

<p><a href="http://jsbin.com/wupixi/edit?js,output">Run example on JSBin</a></p>

<p>This abstraction can be expanded on in other ways. For example a notification
dialog:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">NotifyDialog</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Dialog</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">_this</span>      <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span>        <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notify-dialog'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">messageEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'.message'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">okButton</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'button.ok'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">okButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">_okCallback</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>
<span class="nx">NotifyDialog</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nx">NotifyDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">messageEl</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">NotifyDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">'hidden'</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="exercises-for-the-student">Exercises for the student</h4>

<ol>
  <li>Write a function that takes a <code class="highlighter-rouge">Dialog</code> instance and a default value. Have it
return a promise that resolves to the default value if the user clicks
cancel.</li>
  <li>With the use of abstract classes can the similarities between <code class="highlighter-rouge">PromptDialog</code>
and <code class="highlighter-rouge">NotifyDialog</code> be abstracted? Make a sub class of <code class="highlighter-rouge">Dialog</code> that
abstracts the common DOM code (<code class="highlighter-rouge">DOMDialog</code>). Then refactor the
<code class="highlighter-rouge">PromptDialog</code> and <code class="highlighter-rouge">NotifyDialog</code> to inherate from <code class="highlighter-rouge">DOMDialog</code> but
references the correct DOM selectors.</li>
</ol>

<h2 id="cancellation">Cancellation</h2>

<p>Something missing from the above example is proper error handling. When it comes
to promises it is a best practise to always <em>reject a promise with an Error</em> and
not with plain data such as an object, string, number, or null/undefined. The
reasoning for this is promises are best used as a way to regain some of the
syntax you have with the standard <code class="highlighter-rouge">try {} catch() {}</code> blocks with asynchronous
code.</p>

<p>An advantage of using <code class="highlighter-rouge">Error</code>s is the ability to test why a promise was rejected
and make decisions on that. This ability is also baked into how Bluebird works.
You can pass in a predicate to the <code class="highlighter-rouge">catch()</code> block allowing you to have more
than one block based on what <code class="highlighter-rouge">Error</code> it was rejected with. For example:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">doSomething</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do something with value or fail with an error.</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'testing errors'</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">ArgumentError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'You buggered up something with the arguments.'</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">SyntaxError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Check your syntax!'</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// e is an Error object.</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Well something genaric happened.'</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>In our dialog example perhaps we want to differentiate between a rejected
promise because of some problem (bad AJAX, programming error, etc.) or because
the user pressed the cancel button.</p>

<p>To do this we will have two <code class="highlighter-rouge">catch()</code> functions one for <code class="highlighter-rouge">UserCanceledError</code> and
one for any other <code class="highlighter-rouge">Error</code>. We can make a custom error like so:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">UserCanceledError</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'UserCanceledError'</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s1">'Dialog cancelled'</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">UserCanceledError</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">Error</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</code></pre></div></div>

<p>See <a href="http://stackoverflow.com/a/17891099/227176">this StackOverflow answer</a> for
a more detailed and feature complete way to make custom errors.</p>

<p>Now we can add a <code class="highlighter-rouge">cancel()</code> reject with this in our event listener:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cancel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cancelCallback</span><span class="p">(</span><span class="k">new</span> <span class="nx">UserCanceledError</span><span class="p">());</span>
<span class="p">};</span>

<span class="err">…</span>

<span class="nx">PromptDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">attachDomEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">okButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">_okCallback</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">inputEl</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cancelButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>

<p>And in our usage case we can test for it:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Timeout the dialog in five seconds.</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">prompt</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span> <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span>

<span class="nx">prompt</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="s1">'What is your name?'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">waitForUser</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">UserCanceledError</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'¯</span><span class="err">\\</span><span class="s1">_(ツ)_/¯'</span><span class="p">;</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something bad happened!'</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">prompt</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
  <span class="p">});</span>
</code></pre></div></div>

<p><a href="http://jsbin.com/yaropo/edit?js,output">Run example on JSBin</a></p>

<p><strong>NOTE:</strong> Bluebird supports <a href="api/cancellation.html">cancellation</a> as an optional
feature that is turned off by default. However, its implementation (since
version 3.0) is meant to stop the then and catch callbacks from firing. It is
not helpful in the example of a user cancellation as described here.</p>

<h2 id="progress-bar">Progress bar</h2>

<p>When there are asynchronous tasks that have the ability to notify progress as
they complete it can be tempting to want that in the promise that represents
that task. Unfortunately this is a bit of an anti-pattern. That is because the
point of promises is to represent a value as if it was natural (like it is in
normal synchronous code) and not to be over glorified callback management.</p>

<p>So how then could we represent a progress bar like dialog? Well the answer is to
manage the progress through callbacks outside the promise API. Bluebird has
since <a href="deprecated-apis.html#progression">deprecated the progression feature</a> and
offers an alternative which I hope to illustrate here.</p>

<p>Another key difference between a <em>progress bar</em> dialog and any other dialog
we’ve discussed here is that a progress bar represents information on another
task and <em>not</em> user import. Instead of the program waiting for the user to
provide a value the dialog box is waiting on the program to provide a value
(resolved: 100% complete, rejected: aborted half way through). Because of this
the <em>progress bar</em> dialog would have a different interface then the previous
dialogs we’ve covered. However, there can still be some user interaction so in
essence we are dealing with two promises.</p>

<p>Bluebird has a way to manage more than one promise simultaneously. When you want
to know if more then one promise completes there is a <code class="highlighter-rouge">Promise.all()</code> function
that takes an array of promises and returns a new promise waiting for them all
to resolve. But if any one is rejected the returned promise is immediately
rejected.</p>

<p>Bluebird also has a <code class="highlighter-rouge">Promise.race()</code> function which does the same thing but
doesn’t wait for all of them to finish. That is what we want. An example how
this might look:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">showProgress</span><span class="p">(</span><span class="nx">otherPromise</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">progress</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ProgressbarDialog</span><span class="p">().</span><span class="nx">show</span><span class="p">(</span><span class="s1">'Uploading…'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span><span class="nx">otherPromise</span><span class="p">,</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">waitForUser</span><span class="p">()])</span>
    <span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">progress</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is some example HTML for the Progress Dialog:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;style </span><span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
  <span class="nf">#progress-dialog</span> <span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span>      <span class="m">200px</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span>     <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span>     <span class="nb">thin</span> <span class="nb">solid</span> <span class="no">black</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span>    <span class="m">10px</span><span class="p">;</span>
    <span class="nl">background</span><span class="p">:</span> <span class="no">lightgreen</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nf">#progress-dialog</span> <span class="nc">.progress-bar</span> <span class="p">{</span>
    <span class="nl">border</span><span class="p">:</span>  <span class="m">1px</span> <span class="nb">solid</span> <span class="no">black</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span>  <span class="m">10px</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span>  <span class="m">20px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nf">#progress-dialog</span> <span class="nc">.progress-bar</span><span class="o">&gt;</span><span class="nt">div</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="no">blue</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span>           <span class="m">0</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span>          <span class="m">0</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span>           <span class="nb">none</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span>           <span class="m">20px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"progress-dialog"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"message"</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"progress-bar"</span><span class="nt">&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"cancel"</span><span class="nt">&gt;</span>Cancel<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>The JavaScript is the same as the <code class="highlighter-rouge">PromptDialog</code> only we will add a
<code class="highlighter-rouge">setProgress()</code> method:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">ProgressDialog</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Dialog</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span>           <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'progress-dialog'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">messageEl</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'.message'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">progressBar</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'.progress-bar&gt;div'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cancelButton</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'button.cancel'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">attachDomEvents</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">ProgressDialog</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Dialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nx">ProgressDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">attachDomEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cancelButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">};</span>
<span class="nx">ProgressDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">messageEl</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">ProgressDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">'hidden'</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">ProgressDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setProgress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">percent</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">progressBar</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">percent</span> <span class="o">+</span> <span class="s1">'%'</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>A common misconception is that promises are a form of callback management. This
is not the case and is why the idea of having a progress callback is not part of
the Promise spec. However, much like the Promise library passes in a <code class="highlighter-rouge">resolve</code>
and <code class="highlighter-rouge">reject</code> callback when you create a new promise (<code class="highlighter-rouge">new Promise(…)</code>) we can do
the same patter for a progress callback.</p>

<p>Now to the fun part. For this tutorial we will <em>fake</em> a lengthy file upload by
using <code class="highlighter-rouge">setTimeout</code>. The intent is to provide a promise and to allow a progress
to be periodically ticked away. We will expect a function to be passed which
is called whenever the progress needs updating. And it returns a promise.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">delayedPromise</span><span class="p">(</span><span class="nx">progressCallback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">progress</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="nx">step</span><span class="p">;</span> <span class="c1">// So first run of nextTick will set progress to 0</span>
    <span class="kd">function</span> <span class="nx">nextTick</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">progress</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">progress</span> <span class="o">+=</span> <span class="nx">step</span><span class="p">;</span>
        <span class="nx">progressCallback</span><span class="p">(</span><span class="nx">progress</span><span class="p">);</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">nextTick</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">nextTick</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When we construct our <code class="highlighter-rouge">ProgressDialog</code> we use the <code class="highlighter-rouge">waitForUser()</code> method to
capture the user interaction promise and then use <code class="highlighter-rouge">delayedPromise()</code> to capture
the fake network promise and finally <code class="highlighter-rouge">Promise.reace()</code> to manage the two
simultaneously and end with a single promise as usual.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'DOMContentLoaded'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'action'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'output'</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">prompt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ProgressDialog</span><span class="p">();</span>

  <span class="nx">button</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pendingProgress</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">waitForPromise</span> <span class="o">=</span> <span class="nx">delayedPromise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pendingProgress</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">prompt</span><span class="p">.</span><span class="nx">setProgress</span><span class="p">(</span><span class="nx">progress</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// Prevent user from pressing button while dialog is visible.</span>
    <span class="nx">button</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">prompt</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="s1">'Simulating a file upload.'</span><span class="p">);</span>

    <span class="nb">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span><span class="nx">waitForPromise</span><span class="p">,</span> <span class="nx">prompt</span><span class="p">.</span><span class="nx">waitForUser</span><span class="p">()])</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Progress completed'</span><span class="p">;</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">UserCanceledError</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Progress canceled by user'</span><span class="p">;</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Error'</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">pendingProgress</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">button</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">prompt</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p><a href="http://jsbin.com/bipeve/edit?js,output">Run example on JSBin</a></p>

<p>I hope this helps illustrate some concepts available with Promises and a
different perspective on how promises can represent more then just AJAX data.</p>

<p>Although the code may look verbose it does provide the benefit that it is
modular and can be easily changed. A trait difficult to achieve with a more
procedural style.</p>

<p>Happy coding, <a href="https://github.com/sukima">@sukima</a>.</p>

