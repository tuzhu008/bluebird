<p>This page explains how to interface your code with existing callback APIs and libraries you’re using. We’ll see that making bluebird work with callback APIs is not only easy - it’s also fast.</p>

<p>We’ll cover several subjects. If you want to get the tl;dr what you need is likely the <a href="#working-with-callback-apis-using-the-node-convention">Working with callback APIs using the Node convention</a> section.</p>

<p>First to make sure we’re on the same page:</p>

<p>Promises have state, they start as pending and can settle to:</p>

<ul>
  <li><strong>fulfilled</strong> meaning that the computation completed successfully.</li>
  <li><strong>rejected</strong> meaning that the computation failed.</li>
</ul>

<p>Promise returning functions <em>should never throw</em>, they should always successfully return a promise which is rejected in the case of an error. Throwing from a promise returning function will force you to use both a <code class="highlighter-rouge">} catch { </code> <em>and</em> a <code class="highlighter-rouge">.catch</code>. People using promisified APIs do not expect promises to throw. If you’re not sure how async APIs work in JS - please <a href="http://stackoverflow.com/questions/14220321/how-to-return-the-response-from-an-asynchronous-call/16825593#16825593">see this answer</a> first.</p>

<ul>
  <li><a href="#automatic-vs.-manual-conversion">Automatic vs. Manual conversion</a></li>
  <li><a href="#working-with-callback-apis-using-the-node-convention">Working with callback APIs using the Node convention</a></li>
  <li><a href="#working-with-one-time-events">Working with one time events.</a></li>
  <li><a href="#working-with-delays/setTimeout">Working with delays</a></li>
  <li><a href="#working-with-browser-apis">Working with browser APIs</a></li>
  <li><a href="#working-with-databases">Working with databases</a></li>
  <li><a href="#more-common-examples">More Common Examples</a></li>
  <li><a href="#working-with-any-other-apis">Working with any other APIs</a></li>
</ul>

<p>There is also <a href="http://stackoverflow.com/questions/22519784/how-do-i-convert-an-existing-callback-api-to-promises">this more general StackOverflow question</a> about conversion of callback APIs to promises. If you find anything missing in this guide however, please do open an issue or pull request.</p>

<p>###Automatic vs. Manual conversion</p>

<p>There are two primary methods of converting callback based APIs into promise based ones. You can either manually map the API calls to promise returning functions or you can let the bluebird do it for you. We <strong>strongly</strong> recommend the latter.</p>

<p>Promises provide a lot of really cool and powerful guarantees like throw safety which are hard to provide when manually converting APIs to use promises. Thus, whenever it is possible to use the <code class="highlighter-rouge">Promise.promisify</code> and <code class="highlighter-rouge">Promise.promisifyAll</code> methods - we recommend you use them. Not only are they the safest form of conversion - they also use techniques of dynamic recompilation to introduce very little overhead.</p>

<p>###Working with callback APIs using the Node convention</p>

<p>In Node/io.js most APIs follow a convention of <a href="https://gist.github.com/CrabDude/10907185">‘error-first, single-parameter’</a> as such:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getStuff</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="nx">getStuff</span><span class="p">(</span><span class="s2">"dataParam"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This APIs are what most core modules in Node/io use and bluebird comes with a fast and efficient way to convert them to promise based APIs through the <code class="highlighter-rouge">Promise.promisify</code> and <code class="highlighter-rouge">Promise.promisifyAll</code> function calls.</p>

<ul>
  <li><a href=".">Promise.promisify</a> - converts a <em>single</em> callback taking function into a promise returning function. It does not alter the original function and returns the modified version.</li>
  <li><a href=".">Promise.promisifyAll</a> - takes an <em>object</em> full of functions and <em>converts each function</em> into the new one with the <code class="highlighter-rouge">Async</code> suffix (by default). It does not change the original functions but instead adds new ones.</li>
</ul>

<blockquote>
  <p><strong>Note</strong> - please check the linked docs for more parameters and usage examples.</p>
</blockquote>

<p>Here’s an example of <code class="highlighter-rouge">fs.readFile</code> with or without promises:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// callbacks</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"fs"</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"utf8"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</code></pre></div></div>

<p>Promises:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"fs"</span><span class="p">));</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"utf8"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</code></pre></div></div>

<p>Note the new method is suffixed with <code class="highlighter-rouge">Async</code>, as in <code class="highlighter-rouge">fs.readFileAsync</code>. It did not replace the <code class="highlighter-rouge">fs.readFile</code> function. Single functions can also be promisified for example:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"request"</span><span class="p">));</span>
<span class="nx">request</span><span class="p">(</span><span class="s2">"foo.bar"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong> <code class="highlighter-rouge">Promise.promisify</code> and <code class="highlighter-rouge">Promise.promisifyAll</code> use dynamic recompilation for really fast wrappers and thus calling them should be done only once. <a href=".">Promise.fromCallback</a> exists for cases where this is not possible.</p>
</blockquote>

<p>###Working with one time events</p>

<p>Sometimes we want to find out when a single one time event has finished. For example - a stream is done. For this we can use <a href=".">new Promise</a>. Note that this option should be considered only if <a href="#working-with-callback-apis-using-the-node-convention">automatic conversion</a> isn’t possible.</p>

<p>Note that promises model a <em>single value through time</em>, they only resolve <em>once</em> - so while they’re a good fit for a single event, they are not recommended for multiple event APIs.</p>

<p>For example, let’s say you have a window <code class="highlighter-rouge">onload</code> event you want to bind to. We can use the promise construction and resolve when the window has loaded as such:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// onload example, the promise constructor takes a</span>
<span class="c1">// 'resolver' function that tells the promise when</span>
<span class="c1">// to resolve and fire off its `then` handlers.</span>
<span class="kd">var</span> <span class="nx">loaded</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"load"</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">loaded</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// window is loaded here</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Here is another example with an API that lets us know when a connection is ready. The attempt here is imperfect and we’ll describe why soon:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">connect</span><span class="p">()</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">myConnector</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>  <span class="c1">// Synchronous.</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"ready"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// When a connection has been established</span>
            <span class="c1">// mark the promise as fulfilled.</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If it failed connecting, mark it</span>
            <span class="c1">// as rejected.</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>  <span class="c1">// e is preferably an `Error`.</span>
        <span class="p">});</span>
   <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The problem with the above is that <code class="highlighter-rouge">getConnection</code> itself might throw for some reason and if it does we’ll get a synchronous rejection. An asynchronous operation should always be asynchronous to prevent double guarding and race conditions so it’s best to always put the sync parts inside the promise constructor as such:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">connect</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If getConnection throws here instead of getting</span>
        <span class="c1">// an exception we're getting a rejection thus</span>
        <span class="c1">// producing a much more consistent API.</span>
        <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">myConnector</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"ready"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// When a connection has been established</span>
            <span class="c1">// mark the promise as fulfilled.</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If it failed connecting, mark it</span>
            <span class="c1">// as rejected.</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="c1">//  e is preferably an `Error`</span>
        <span class="p">});</span>
   <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
<p>###Working with delays/setTimeout</p>

<p>There is no need to convert timeouts/delays to a bluebird API, bluebird already ships with the <a href=".">Promise.delay</a> function for this use case. Please consult the <a href=".">timers</a> section of the docs on usage and examples.</p>

<p>###Working with browser APIs</p>

<p>Often browser APIs are nonstandard and automatic promisification will fail for them. If you’re running into an API that you can’t promisify with <a href=".">promisify</a> and <a href=".">promisifyAll</a> - please consult the <a href="#working-with-any-other-apis">working with other APIs section</a></p>

<p>###Working with databases</p>

<p>For resource management in general and databases in particular, bluebird includes the powerful  <a href=".">Promise.using</a> and disposers system. This is similar to <code class="highlighter-rouge">with</code> in Python, <code class="highlighter-rouge">using</code> in C#, try/resource in Java or RAII in C++ in that it lets you handle resource management in an automatic way.</p>

<p>Several examples of databases follow.</p>

<blockquote>
  <p><strong>Note</strong> for more examples please see the <a href=".">Promise.using</a> section.</p>
</blockquote>

<p>####Mongoose/MongoDB</p>

<p>Mongoose works with persistent connections and the driver takes care of reconnections/disposals. For this reason using <code class="highlighter-rouge">using</code> with it isn’t required - instead connect on server startup and use promisification to expose promises.</p>

<p>Note that Mongoose already ships with promise support but the promises it offers are significantly slower and don’t report unhandled rejections so it is recommended to use automatic promisification with it anyway:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Mongoose</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">));</span>
</code></pre></div></div>

<p>####Sequelize</p>

<p>Sequelize already uses Bluebird promises internally and has promise returning APIs. Use those.</p>

<p>####RethinkDB</p>

<p>Rethink already uses Bluebird promises internally and has promise returning APIs. Use those.</p>

<p>####Bookshelf</p>

<p>Bookshelf already uses Bluebird promises internally and has promise returning APIs. Use those.</p>

<p>####PostgreSQL</p>

<p>Here is how to create a disposer for the PostgreSQL driver:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">pg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"pg"</span><span class="p">);</span>
<span class="c1">// Uncomment if pg has not been properly promisified yet.</span>
<span class="c1">//var Promise = require("bluebird");</span>
<span class="c1">//Promise.promisifyAll(pg, {</span>
<span class="c1">//    filter: function(methodName) {</span>
<span class="c1">//        return methodName === "connect"</span>
<span class="c1">//    },</span>
<span class="c1">//    multiArgs: true</span>
<span class="c1">//});</span>
<span class="c1">// Promisify rest of pg normally.</span>
<span class="c1">//Promise.promisifyAll(pg);</span>

<span class="kd">function</span> <span class="nx">getSqlConnection</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">close</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pg</span><span class="p">.</span><span class="nx">connectAsync</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">close</span> <span class="o">=</span> <span class="nx">done</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">close</span><span class="p">)</span> <span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">getSqlConnection</span><span class="p">;</span>
</code></pre></div></div>

<p>Which would allow you to use:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">using</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">using</span><span class="p">;</span>

<span class="nx">using</span><span class="p">(</span><span class="nx">getSqlConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// use connection here and _return the promise_</span>

<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// connection already disposed here</span>

<span class="p">});</span>
</code></pre></div></div>

<p>It’s also possible to use a disposer pattern (but not actual disposers) for transaction management:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">function</span> <span class="nx">withTransaction</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">using</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">acquireConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">beginTransaction</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">Promise</span>
      <span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">tx</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">commit</span><span class="p">().</span><span class="nx">thenReturn</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">},</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">()</span>
                     <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* maybe add the rollback error to err */</span><span class="p">})</span>
                     <span class="p">.</span><span class="nx">thenThrow</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">withTransaction</span> <span class="o">=</span> <span class="nx">withTransaction</span><span class="p">;</span>
</code></pre></div></div>

<p>Which would let you do:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">withTransaction</span><span class="p">(</span><span class="nx">tx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...)</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...)</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>####MySQL</p>

<p>Here is how to create a disposer for the MySQL driver:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mysql"</span><span class="p">);</span>
<span class="c1">// Uncomment if mysql has not been properly promisified yet</span>
<span class="c1">// var Promise = require("bluebird");</span>
<span class="c1">// Promise.promisifyAll(mysql);</span>
<span class="c1">// Promise.promisifyAll(require("mysql/lib/Connection").prototype);</span>
<span class="c1">// Promise.promisifyAll(require("mysql/lib/Pool").prototype);</span>
<span class="kd">var</span> <span class="nx">pool</span>  <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
    <span class="na">connectionLimit</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'example.org'</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="s1">'bob'</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="s1">'secret'</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getSqlConnection</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnectionAsync</span><span class="p">().</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">getSqlConnection</span><span class="p">;</span>
</code></pre></div></div>

<p>The usage pattern is similar to the PostgreSQL example above. You can also use a disposer pattern (but not an actual .disposer). See the PostgreSQL example above for instructions.</p>

<p>###More common examples</p>

<p>Some examples of the above practice applied to some popular libraries:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The most popular redis module</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"redis"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The most popular mongodb module</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"mongodb"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The most popular mysql module</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="c1">// Note that the library's classes are not properties of the main export</span>
<span class="c1">// so we require and promisifyAll them manually</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"mysql/lib/Connection"</span><span class="p">).</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"mysql/lib/Pool"</span><span class="p">).</span><span class="nx">prototype</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Mongoose</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Request</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"request"</span><span class="p">));</span>
<span class="c1">// Use request.getAsync(...) not request(..), it will not return a promise</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// mkdir</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"mkdirp"</span><span class="p">));</span>
<span class="c1">// Use mkdirp.mkdirpAsync not mkdirp(..), it will not return a promise</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// winston</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"winston"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// rimraf</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="c1">// The module isn't promisified but the function returned is</span>
<span class="kd">var</span> <span class="nx">rimrafAsync</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"rimraf"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// xml2js</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"xml2js"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// jsdom</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"jsdom"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// fs-extra</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"fs-extra"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// prompt</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"prompt"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Nodemailer</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"nodemailer"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ncp</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"ncp"</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// pg</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"pg"</span><span class="p">));</span>
</code></pre></div></div>

<p>In all of the above cases the library made its classes available in one way or another. If this is not the case, you can still promisify by creating a throwaway instance:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">ParanoidLib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"..."</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">throwAwayInstance</span> <span class="o">=</span> <span class="nx">ParanoidLib</span><span class="p">.</span><span class="nx">createInstance</span><span class="p">();</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">throwAwayInstance</span><span class="p">));</span>
<span class="c1">// Like before, from this point on, all new instances + even the throwAwayInstance suddenly support promises</span>
</code></pre></div></div>

<p>###Working with any other APIs</p>

<p>Sometimes you have to work with APIs that are inconsistent and do not follow a common convention.</p>

<blockquote>
  <p><strong>Note</strong> Promise returning function should never throw</p>
</blockquote>

<p>For example, something like:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getUserData</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">onLoad</span><span class="p">,</span> <span class="nx">onFail</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span>
</code></pre></div></div>

<p>We can use the promise constructor to convert it to a promise returning function:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getUserDataAsync</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Put all your code here, this section is throw-safe.</span>
        <span class="nx">getUserData</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
