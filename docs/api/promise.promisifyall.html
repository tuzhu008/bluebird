<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,200,700,500,100,800,600,900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <title>Promise.promisifyAll | bluebird</title>
    <meta name="description" content="Bluebird is a fully featured JavaScript promises library with unmatched performance.">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="/bluebird_cn/css/mono-blue.css" type='text/css' />
    <link rel="stylesheet" href="/bluebird_cn/css/hover-min.css" media="all">
    <link rel="stylesheet" href="/bluebird_cn/css/main.css">
    <link rel="canonical" href="https://tuzhu008.github.io/bluebird_cn/docs/api/promise.promisifyall.html">
    <link rel="icon" href="/bluebird_cn/img/favicon.png" type="image/png" />
  </head>

  <body>

    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="title">
                    <img src="/bluebird_cn/img/libbblog_v3.png" class="hidden-xs" alt="bluebird logo" />

                    <span class="tagline">bluebird</span>
                </a>
            </div>
            <div id="navbar" class="navbar-collapse navbar-bluebird navbar-right collapse">
                <ul class="nav navbar-nav bb-nav">
                    

                    <li class=""><a href="/bluebird_cn/docs/api-reference.html">API</a></li>
                    <li class="active"><a href="/bluebird_cn/docs/getting-started.html">文档</a></li>
                    <li class=""><a href="/bluebird_cn/docs/support.html">支持</a></li>
                    <li class=""><a href="/bluebird_cn/docs/install.html">安装</a></li>
                    <li><a href="https://github.com/petkaantonov/bluebird/">Github</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>

   <div class="container">
      <div class="row">
        <div class="col-sm-3">
            <ul class="nav left-nav">
                <li><a href="/bluebird_cn/docs/getting-started.html">开始</a></li>
                <li><a href="/bluebird_cn/docs/features.html">特性</a></li>
                <li><a href="/bluebird_cn/docs/changelog.html">更新日志</a></li>
                <li><a href="/bluebird_cn/docs/api-reference.html"><strong>API 参考</strong></a></li>
                <li><a href="/bluebird_cn/docs/new-in-bluebird-3.html"><strong>New in 3.0</strong></a></li>
                <li><a href="/bluebird_cn/docs/warning-explanations.html">警告说明</a></li>
                <li><a href="/bluebird_cn/docs/error-explanations.html">错误说明</a></li>
                <li><a href="/bluebird_cn/docs/contribute.html">贡献</a></li>
                <li><a href="/bluebird_cn/docs/benchmarks.html">Benchmarks</a></li>
                <li><a href="/bluebird_cn/docs/deprecated-apis.html">弃用的 API</a></li>
                <li><a href="/bluebird_cn/docs/download-api-reference.html">下载 API 参考</a></li>
                <li><hr></li>
                <li>Why?
                    <ul class="nav nav-child">
                        <li><a href="/bluebird_cn/docs/why-promises.html">Why Promises?</a></li>
                        <li><a href="/bluebird_cn/docs/why-bluebird.html">Why bluebird?</a></li>
                        <li><a href="/bluebird_cn/docs/why-performance.html">Why Performance?</a></li>
                        <li><a href="/bluebird_cn/docs/what-about-generators.html">What About Generators?</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    教程
                    <ul class="nav nav-child">
                        <li><a href="/bluebird_cn/docs/async-dialogs.html">Async Dialogs</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    指南
                    <ul class="nav nav-child">
                        <li><a href="/bluebird_cn/docs/beginners-guide.html">初学者指南</a></li>
                        <li><a href="/bluebird_cn/docs/anti-patterns.html">Anti-patterns</a></li>
                        <li><a href="/bluebird_cn/docs/working-with-callbacks.html">使用回调</a></li>
                        <li><a href="/bluebird_cn/docs/coming-from-other-languages.html">来自其他语言</a></li>
                        <li><a href="/bluebird_cn/docs/coming-from-other-libraries.html">来自其他库</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    <div class="supporters">
                        <div class="reaktor supporter">
                            <a href="https://reaktor.com">
                                <img src="/bluebird_cn/img/supportlogo.png" alt="Supported by reaktor" title="Supported by Reaktor">
                            </a>
                        </div>
                    </div>
                </li>

            </ul>
        </div>
        <div class="col-sm-9">
            
            <div class="post-info">
                <a href="https://github.com/tuzhu008/bluebird_cn/edit/master/docs/docs/api/promise.promisifyall.md">
                    <i class="fa fa-edit"></i>
                    编辑此页</a>
                <br>
                <i>更新于 03 Jan 2018</i>
            </div>
            <div class="clearfix"></div>
            
            <div class="post">
  <article class="post-content">
    <p><a href='/bluebird_cn/docs/api-reference.html' title=''>← Back To API Reference</a>
<div class="api-code-section"><markdown></p>
            <h2>
                <a class="header-anchor"
                    name="promise.promisifyall"
                    aria-hidden="true"
                    href="#promise.promisifyall"><i class="fa fa-link"></i></a>
                Promise.promisifyAll
            </h2>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span>
    <span class="nb">Object</span> <span class="nx">target</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span>
        <span class="nx">suffix</span><span class="o">:</span> <span class="nb">String</span><span class="o">=</span><span class="s2">&quot;Async&quot;</span><span class="p">,</span>
        <span class="nx">multiArgs</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span>
        <span class="nx">filter</span><span class="o">:</span> <span class="kr">boolean</span> <span class="kd">function</span><span class="p">(</span><span class="nb">String</span> <span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">func</span><span class="p">,</span> <span class="nb">Object</span> <span class="nx">target</span><span class="p">,</span> <span class="kr">boolean</span> <span class="nx">passesDefaultFilter</span><span class="p">),</span>
        <span class="nx">promisifier</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="kd">function</span> <span class="nx">originalFunction</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">defaultPromisifier</span><span class="p">)</span>
    <span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Object</span>
</code></pre></div>
<p>通过遍历对象的属性来 promise化整个对象，并在对象和原型链上创建每个函数的异步等价物。 promise化的方法的名称将是后缀为<code>suffix</code>的原始方法名称（默认为 <code>&quot;Async&quot;</code>）。对象的任何类属性（许多模块的主要导出都是这种情况）也被普遍使用，包括静态方法和实例方法。 Class属性是一个具有非空的 <code>.prototype</code> 对象的函数值的属性。返回输入对象。</p>

<p>请注意，对象上的原始方法不会被覆盖，而是使用 <code>Async</code> 后缀创建新方法。 例如，如果你 <code>promisifyAll</code>，node.js <code>fs</code> 对象，使用 <code>fs.statAsync</code> 来调用 promise化的 <code>stat</code> 方法。</p>

<p>示例:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">));</span>

<span class="c1">// 稍后，所有的 redis 客户端实例都有 promise 返回函数：</span>

<span class="nx">redisClient</span><span class="p">.</span><span class="nx">hexistsAsync</span><span class="p">(</span><span class="s2">&quot;myhash&quot;</span><span class="p">,</span> <span class="s2">&quot;field&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</code></pre></div>
<p>它也适用于单例或特定实例：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;myfile.js&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>参见 <a href='#promisification' title=''>promisification</a> 获得更多示例。</p>

<p>对象的整个原型链被 promise 化在了对象上。只有可枚举的属性才被考虑。如果对象已经有了 promise化版本的方法，它将被跳过。目标方法被假定为符合接受接受回调作为最后一个参数的 node.js 回调约定，并将错误作为第一个参数和成功值作为第二个参数的调用该回调。如果 node 方法使用多个成功值调用其回调，则履行值将是它们的一个数组。</p>

<p>如果一个方法已经有了 <code>&quot;Async&quot;</code> 后缀，它会被复制。例如， <code>getAsync</code> 的 promise 化的名字为  <code>getAsyncAsync</code>。</p>
            <h4>
                <a class="header-anchor"
                    name="suffix"
                    aria-hidden="true"
                    href="#suffix"><i class="fa fa-link"></i></a>
                选项： suffix
            </h4>

<p>或者，您可以通过选项对象定义一个自定义后缀：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">),</span> <span class="p">{</span><span class="nx">suffix</span><span class="o">:</span> <span class="s2">&quot;MySuffix&quot;</span><span class="p">});</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileMySuffix</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(...);</span>
</code></pre></div>
<p>以下所有的限制都适用于自定义:</p>

<ul>
<li>仔细选择后缀，不能与任何东西冲突</li>
<li>PascalCase 的后缀</li>
<li>后缀必须是使用 ASCII 字母的有效 JavaScript 标识符</li>
<li>在您的应用程序中始终使用相同的后缀，您可以创建一个包装器，使其更容易：</li>
</ul>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">myPromisifyAll</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="p">{</span><span class="nx">suffix</span><span class="o">:</span> <span class="s2">&quot;MySuffix&quot;</span><span class="p">});</span>
<span class="p">};</span>
</code></pre></div>            <h4>
                <a class="header-anchor"
                    name="multiargs"
                    aria-hidden="true"
                    href="#multiargs"><i class="fa fa-link"></i></a>
                选项： multiArgs
            </h4>

<p>Setting <code>multiArgs</code> to <code>true</code> means the resulting promise will always fulfill with an array of the callback&#39;s success value(s). This is needed because promises only support a single success value while some callback API&#39;s have multiple success value. The default is to ignore all but the first success value of a callback function.
将 <code>multiArgs</code> 设置为 <code>true</code> 意味着所得到的 promise 将总是以一个回调的成功值的数组来履行。这是必要的，因为 promise 只支持单个成功值，而一些回调 API 有多个成功值。默认情况下忽略除回调函数的第一个成功值之外的所有值。</p>

<p>如果一个模块有多参数回调作为异常而不是规则，那么你可以先过滤掉多个参数方法，然后在第二个步骤中将模块的其余部分放在一边：
If a module has multiple argument callbacks as an exception rather than the rule, you can filter out the multiple argument methods in first go and then promisify rest of the module in second go:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">something</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">name</span> <span class="o">===</span> <span class="s2">&quot;theMultiArgMethodIwant&quot;</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">multiArgs</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">});</span>
<span class="c1">// Rest of the methods</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">something</span><span class="p">);</span>
</code></pre></div>            <h4>
                <a class="header-anchor"
                    name="filter"
                    aria-hidden="true"
                    href="#filter"><i class="fa fa-link"></i></a>
                选项： filter
            </h4>

<p>可选的，您可以通过选项对象定义一个自定义过滤器:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(...,</span> <span class="p">{</span>
    <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">passesDefaultFilter</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// name = 将被 promise 化的属性名</span>
        <span class="c1">// func = the function</span>
        <span class="c1">// target = 目标对象，其中 promise 化的 fun 将使用 name + suffix 放置</span>
        <span class="c1">// passesDefaultFilter = 表示是否会传递默认过滤器，返回一个布尔值(返回值是被强制的，因此不返回任何东西与返回 false 相同)</span>

        <span class="k">return</span> <span class="nx">passesDefaultFilter</span> <span class="o">&amp;&amp;</span> <span class="p">...</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
<p>默认的过滤器函数将忽略以下划线开头的属性，这些属性不是有效的 JavaScript 标识符和构造函数(这里的函数是指在它们的 <code>.prototype</code> 中具有可枚举的属性)。</p>
            <h4>
                <a class="header-anchor"
                    name="promisifier"
                    aria-hidden="true"
                    href="#promisifier"><i class="fa fa-link"></i></a>
                选项： promisifier
            </h4>

<p>可选，您可以定义一个自定义 promisifier，所以你可以promisifyAll 例如在 Chrome 扩展程序中使用的Chrome API。</p>

<p>Promisifier 获取对原始方法的引用，并应该返回一个返回promise 的函数。</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">function</span> <span class="nx">DOMPromisifier</span><span class="p">(</span><span class="nx">originalMethod</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// return a function</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">promisified</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
        <span class="c1">// Needed so that the original method can be called with the correct receiver</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="c1">// which returns a promise</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
            <span class="nx">originalMethod</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Promisify e.g. chrome.browserAction</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">,</span> <span class="p">{</span><span class="nx">promisifier</span><span class="o">:</span> <span class="nx">DOMPromisifier</span><span class="p">});</span>

<span class="c1">// Later</span>
<span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">getTitleAsync</span><span class="p">({</span><span class="nx">tabId</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">});</span>
</code></pre></div>
<p>Combining <code>filter</code> with <code>promisifier</code> for the restler module to promisify event emitter:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">restler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;restler&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">methodNamesToPromisify</span> <span class="o">=</span> <span class="s2">&quot;get post put del head patch json postJson putJson&quot;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">EventEmitterPromisifier</span><span class="p">(</span><span class="nx">originalMethod</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// return a function</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">promisified</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
        <span class="c1">// Needed so that the original method can be called with the correct receiver</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="c1">// which returns a promise</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We call the originalMethod here because if it throws,</span>
            <span class="c1">// it will reject the returned promise with the thrown error</span>
            <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">originalMethod</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>

            <span class="nx">emitter</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">resolve</span><span class="p">([</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">]);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// Erroneous response like 400</span>
                    <span class="nx">resolve</span><span class="p">([</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">]);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;abort&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">CancellationError</span><span class="p">());</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">TimeoutError</span><span class="p">());</span>
                <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">restler</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">methodNamesToPromisify</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">promisifier</span><span class="o">:</span> <span class="nx">EventEmitterPromisifier</span>
<span class="p">});</span>

<span class="c1">// ...</span>

<span class="c1">// Later in some other file</span>

<span class="kd">var</span> <span class="nx">restler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;restler&quot;</span><span class="p">);</span>
<span class="nx">restler</span><span class="p">.</span><span class="nx">getAsync</span><span class="p">(</span><span class="s2">&quot;http://...&quot;</span><span class="p">,</span> <span class="p">...,).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

<span class="p">})</span>
</code></pre></div>
<p>Using <code>defaultPromisifier</code> parameter to add enhancements on top of normal node
promisification:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">),</span> <span class="p">{</span>
    <span class="nx">promisifier</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">originalFunction</span><span class="p">,</span> <span class="nx">defaultPromisifer</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">promisified</span> <span class="o">=</span> <span class="nx">defaultPromisifier</span><span class="p">(</span><span class="nx">originalFunction</span><span class="p">);</span>

        <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// Enhance normal promisification by supporting promises as</span>
            <span class="c1">// arguments</span>

            <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">args</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">awaitedArgs</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">promisified</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">awaitedArgs</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// All promisified fs functions now await their arguments if they are promises</span>
<span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;package.json&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileAsync</span><span class="p">(</span><span class="s2">&quot;the-version.txt&quot;</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">);</span>
</code></pre></div>            <h4>
                <a class="header-anchor"
                    name="promise"
                    aria-hidden="true"
                    href="#promise"><i class="fa fa-link"></i></a>
                promise 化多个类
            </h4>

<p>您可以通过在类中构造一个数组并将其传递给 <code>promisifyAll</code> 来一次性 promise 化多个类：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">Pool</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql/lib/Pool&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Connection</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql/lib/Connection&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">([</span><span class="nx">Pool</span><span class="p">,</span> <span class="nx">Connection</span><span class="p">]);</span>
</code></pre></div>
<p>之所以能这样做，是因为数组充当“模块”，索引是类的“模块”属性。</p>

<p></markdown></div></p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_title = "Promise.promisifyAll";
    var disqus_shortname = "bluebirdjs";
    var disqus_identifier = "disqus-id-promise.promisifyall";
    
    (function() {
        var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
        dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
        (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </article>
</div>

        </div>
      </div>
  </div>
    <footer>
      <div class="container">
        <p style="text-align:center">本站翻译自 <a href='https://github.com/petkaantonov/bluebird/'>bluebird</a></p>
      </div>
    </footer>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="//cdn.jsdelivr.net/bluebird/3.5.1/bluebird.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46253177-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>

</html>
