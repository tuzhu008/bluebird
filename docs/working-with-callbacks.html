<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,200,700,500,100,800,600,900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <title>使用回调 | bluebird</title>
    <meta name="description" content="Bluebird is a fully featured JavaScript promises library with unmatched performance.">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="/bluebird_cn/css/mono-blue.css" type='text/css' />
    <link rel="stylesheet" href="/bluebird_cn/css/hover-min.css" media="all">
    <link rel="stylesheet" href="/bluebird_cn/css/main.css">
    <link rel="canonical" href="https://tuzhu008.github.io/bluebird_cn/docs/working-with-callbacks.html">
    <link rel="icon" href="/bluebird_cn/img/favicon.png" type="image/png" />
  </head>

  <body>

    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="title">
                    <img src="/bluebird_cn/img/libbblog_v3.png" class="hidden-xs" alt="bluebird logo" />

                    <span class="tagline">bluebird</span>
                </a>
            </div>
            <div id="navbar" class="navbar-collapse navbar-bluebird navbar-right collapse">
                <ul class="nav navbar-nav bb-nav">
                    

                    <li class=""><a href="/bluebird_cn/docs/api-reference.html">API</a></li>
                    <li class="active"><a href="/bluebird_cn/docs/getting-started.html">文档</a></li>
                    <li class=""><a href="/bluebird_cn/docs/support.html">支持</a></li>
                    <li class=""><a href="/bluebird_cn/docs/install.html">安装</a></li>
                    <li><a href="https://github.com/petkaantonov/bluebird/">Github</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>

   <div class="container">
      <div class="row">
        <div class="col-sm-3">
            <ul class="nav left-nav">
                <li><a href="/bluebird_cn/docs/getting-started.html">开始</a></li>
                <li><a href="/bluebird_cn/docs/features.html">特性</a></li>
                <li><a href="/bluebird_cn/docs/changelog.html">更新日志</a></li>
                <li><a href="/bluebird_cn/docs/api-reference.html"><strong>API 参考</strong></a></li>
                <li><a href="/bluebird_cn/docs/new-in-bluebird-3.html"><strong>New in 3.0</strong></a></li>
                <li><a href="/bluebird_cn/docs/warning-explanations.html">警告说明</a></li>
                <li><a href="/bluebird_cn/docs/error-explanations.html">错误说明</a></li>
                <li><a href="/bluebird_cn/docs/contribute.html">贡献</a></li>
                <li><a href="/bluebird_cn/docs/benchmarks.html">Benchmarks</a></li>
                <li><a href="/bluebird_cn/docs/deprecated-apis.html">弃用的 API</a></li>
                <li><a href="/bluebird_cn/docs/download-api-reference.html">下载 API 参考</a></li>
                <li><hr></li>
                <li>Why?
                    <ul class="nav nav-child">
                        <li><a href="/bluebird_cn/docs/why-promises.html">Why Promises?</a></li>
                        <li><a href="/bluebird_cn/docs/why-bluebird.html">Why bluebird?</a></li>
                        <li><a href="/bluebird_cn/docs/why-performance.html">Why Performance?</a></li>
                        <li><a href="/bluebird_cn/docs/what-about-generators.html">What About Generators?</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    教程
                    <ul class="nav nav-child">
                        <li><a href="/bluebird_cn/docs/async-dialogs.html">Async Dialogs</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    指南
                    <ul class="nav nav-child">
                        <li><a href="/bluebird_cn/docs/beginners-guide.html">初学者指南</a></li>
                        <li><a href="/bluebird_cn/docs/anti-patterns.html">Anti-patterns</a></li>
                        <li><a href="/bluebird_cn/docs/working-with-callbacks.html">使用回调</a></li>
                        <li><a href="/bluebird_cn/docs/coming-from-other-languages.html">来自其他语言</a></li>
                        <li><a href="/bluebird_cn/docs/coming-from-other-libraries.html">来自其他库</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    <div class="supporters">
                        <div class="reaktor supporter">
                            <a href="https://reaktor.com">
                                <img src="/bluebird_cn/img/supportlogo.png" alt="Supported by reaktor" title="Supported by Reaktor">
                            </a>
                        </div>
                    </div>
                </li>

            </ul>
        </div>
        <div class="col-sm-9">
            
            <div class="post-info">
                <a href="https://github.com/tuzhu008/bluebird_cn/edit/master/docs/docs/working-with-callbacks.md">
                    <i class="fa fa-edit"></i>
                    编辑此页</a>
                <br>
                <i>更新于 02 Jan 2018</i>
            </div>
            <div class="clearfix"></div>
            
            <div class="post">

  <header class="post-header">
    <h1 class="post-title">使用回调</h1>
  </header>

  <article class="post-content">
    <p>这个页面解释了如何与现有的回调 api 和正在使用的库进行连接。我们将会看到，bluebird 使用回调 API 不仅很简单，而且还非常快。</p>

<p>我们将讨论一些主题。If you want to get the tl;dr what you need is likely the <a href='#working-with-callback-apis-using-the-node-convention' title=''>使用 Node 约定与回调 API 一起工作</a> 部分。</p>

<p>首先要确保我们在同一个页面上:</p>

<p>Promises 是有状态的，它们以等待的状态开始，并可以解决:</p>

<ul>
<li><strong>fulfilled</strong> 也就是说，计算成功地完成了。</li>
<li><strong>rejected</strong> 这意味着计算失败了。</li>
</ul>

<p>Promise 返回函数 <em>不应该抛出</em>，它们应该总是成功地返回一个在错误情况下被拒绝(rejected)的 promise。从 promise 返回函数抛出将迫使你使用 <code>} catch {</code> <em>和</em> 一个 <code>.catch</code>。 使用 promise化的 APIs 的人不期望 promises 会抛出。 如果您不确定异步 API 如何在 JS 中工作 - 请首先<a href='http://stackoverflow.com/questions/14220321/how-to-return-the-response-from-an-asynchronous-call/16825593#16825593' title=''>查看这个答案</a>。</p>

<ul>
<li><a href='#automatic-vs.-manual-conversion' title=''>自动 vs. 手动转换</a></li>
<li><a href='#working-with-callback-apis-using-the-node-convention' title=''>使用 Node 约定与回调 API 合作</a></li>
<li><a href='#working-with-one-time-events' title=''>使用一次性事件</a></li>
<li><a href='#working-with-delays/setTimeout' title=''>使用延迟</a></li>
<li><a href='#working-with-browser-apis' title=''>使用浏览器 API</a></li>
<li><a href='#working-with-databases' title=''>使用 databases</a></li>
<li><a href='#more-common-examples' title=''>更常见的例子</a></li>
<li><a href='#working-with-any-other-apis' title=''>使用任何其他 API</a></li>
</ul>

<p>还有一个<a href='http://stackoverflow.com/questions/22519784/how-do-i-convert-an-existing-callback-api-to-promises' title=''>更常见的 StackOverflow 问题</a>，关于如何将回调 API 转换成 promise。如果您在本指南中发现任何遗漏，请打开一个问题或拉请求。</p>

<p><a href='#automatic-vs.-manual-conversion'></a></p>
            <h3>
                <a class="header-anchor"
                    name="vs."
                    aria-hidden="true"
                    href="#vs."><i class="fa fa-link"></i></a>
                自动 vs. 手动转换
            </h3>

<p>有两种主要的方法可以将基于回调的 API 转换为基于 promise 的 API。您可以手动映射 API 调用到 promise 返回函数，或者您可以让 bluebird 为您做这件事。我们<strong>强烈</strong>推荐后者。</p>

<p>Promises 提供了很多非常酷和强大的保证，比如在手动转换 API 时很难提供安全保障。因此，只要有可能使用 <code>Promise.promisify</code> 和 <code>Promise.promisifyAll</code> 方法，我们推荐你使用它们。它们不仅是最安全的转换形式——它们还使用动态重新编译技术来引入很少的开销。</p>

<p><a href='#working-with-callback-apis-using-the-node-convention'></a></p>
            <h3>
                <a class="header-anchor"
                    name="node--api"
                    aria-hidden="true"
                    href="#node--api"><i class="fa fa-link"></i></a>
                使用 Node 约定与回调 API 合作
            </h3>

<p>在 Node/io.js 中，大多数 API 遵循一个约定 <a href='https://gist.github.com/CrabDude/10907185' title=''>&#39;error-first, single-parameter&#39;</a> 像这样:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">function</span> <span class="nx">getStuff</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="nx">getStuff</span><span class="p">(</span><span class="s2">&quot;dataParam&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>这些 API 是 Node/io 使用的大多数核心模块，而 bluebird 采用了一种快速高效的方式将它们转换为基于 promise 的 API，通过基于承诺的api。promisify”和“的承诺。promisifyAll的函数调用。</p>

<ul>
<li><a href='/bluebird_cn/docs/api/promise.promisify.html'><code>Promise.promisify</code></a> —— 将一个回调函数转换成一个返回函数。它不会改变原来的函数并返回修改后的版本。将一个 <em>单一的</em> 回调函数转换为一个 promise 返回函数。它不会改变原来的函数，并返回修改后的版本。</li>
<li><a href='/bluebird_cn/docs/api/promise.promisifyall.html'><code>Promise.promisifyAll</code></a> —— 接受一个充满函数的 <em>对象</em>，并将 <em>每个函数</em> 转换为带有 <code>Async</code> 后缀的新函数(默认情况下)。它并没有改变原来的函数，而是添加了新的函数。</li>
</ul>

<blockquote>
<p><strong>注意</strong> - 请检查链接文档以获得更多参数和使用示例.</p>
</blockquote>

<p>这是一个 <code>fs.readFile</code> 的例子:</p>

<p>未使用 promise：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// callbacks</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</code></pre></div>
<p>Promises:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</code></pre></div>
<p>注意，新方法是带有 <code>Async</code> 后缀，以 <code>fs.readFileAsync</code> 存在。它不会替换 <code>fs.readFile</code> 函数。单个函数也可以被 promise化：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">));</span>
<span class="nx">request</span><span class="p">(</span><span class="s2">&quot;foo.bar&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</code></pre></div>
<blockquote>
<p><strong>注意</strong> <code>Promise.promisify</code> 和 <code>Promise.promisifyAll</code> 使用动态重新编译来实现快速的包装，因此应该只调用它们一次。 <a href='/bluebird_cn/docs/api/promise.fromcallback.html'><code>Promise.fromCallback</code></a> 存在的情况下，这是不可能的。</p>
</blockquote>

<p><a href='#working-with-one-time-events'></a></p>
            <h3>
                <a class="header-anchor"
                    name=""
                    aria-hidden="true"
                    href="#"><i class="fa fa-link"></i></a>
                使用一次性事件
            </h3>

<p>有时候我们想知道一个单一的一次性事件何时完成。 例如 —— 一个流完成。为此我们可以使用 <a href='/bluebird_cn/docs/api/new-promise.html'><code>new Promise</code></a>。 请注意，只有在<a href='#working-with-callback-apis-using-the-node-convention' title=''>自动转换</a>不可用时才应考虑此选项。</p>

<p>请注意，promises 会<em>通过 time 对单个值</em>进行建模，它们只解决<em>一次</em>——因此，当它们适合于单个事件时，不推荐将它们用于多事件 APIs。</p>

<p>例如，假设您有一个您想要绑定到的窗口 <code>onload</code> 事件。当窗口加载完成时，我们可以使用 promise 构造和解析:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// onload 示例,  promise 构造函数接受一个</span>
<span class="c1">// &#39;resolver&#39; 函数，这告诉 promise  这告诉 promise 什么时候去解决，并触发它的 `then` 处理程序。·</span>
<span class="kd">var</span> <span class="nx">loaded</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">loaded</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// window is loaded here</span>
<span class="p">});</span>
</code></pre></div>
<p>下面是另一个使用 API 的例子，它可以让我们知道什么时候连接就绪。这里的尝试是不完美的，我们很快就会解释为什么：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">function</span> <span class="nx">connect</span><span class="p">()</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">myConnector</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>  <span class="c1">// 同步.</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// 当连接建立起来时，把 promise 变为 fulfilled。</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 如果连接错误, 把 promise 变为 rejected</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>  <span class="c1">// e 最好是一个 `Error`.</span>
        <span class="p">});</span>
   <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>上面的问题是 <code>getConnection</code> 本身可能会抛出一些原因，如果这样做，我们会得到一个同步拒绝。一个异步操作应该始终是异步的，以防止双重守护和竞争条件，所以最好始终将同步部分放在 promise 构造函数中，如下所示：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">function</span> <span class="nx">connect</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 如果 getConnection 在这里抛出，而不是得到一个异常，我们得将获得一个拒绝，从而产生一个更一致的 API。</span>
        <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">myConnector</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// 当连接建立起来时，把 promise 变为 fulfilled。</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// 如果连接错误, 把 promise 变为 rejected</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>  <span class="c1">// e 最好是一个 `Error`.</span>
        <span class="p">});</span>
   <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p><a href='#working-with-delays/setTimeout'></a></p>
            <h3>
                <a class="header-anchor"
                    name=""
                    aria-hidden="true"
                    href="#"><i class="fa fa-link"></i></a>
                使用延时
            </h3>

<p>没有必要将超时/延迟转换为 bluebird API，bluebird 已经为这个用例提供了 <a href='/bluebird_cn/docs/api/promise.delay.html'><code>Promise.delay</code></a> 函数。请参阅文档中有关 <a href='/bluebird_cn/docs/api/timers.html'><code>timers</code></a> 的使用和示例部分。</p>

<p><a href='#working-with-browser-apis'></a></p>
            <h3>
                <a class="header-anchor"
                    name="apis"
                    aria-hidden="true"
                    href="#apis"><i class="fa fa-link"></i></a>
                使用浏览器 APIs
            </h3>

<p>通常，浏览器 API 是不标准的，自动的 promise化 将会失败。如果您正在使用一个 API，您无法通过 <a href='/bluebird_cn/docs/api/promisify.html'><code>promisify</code></a> 和 <a href='/bluebird_cn/docs/api/promisifyall.html'><code>promisifyAll</code></a> 来进行 promise化，请参考 <a href='#working-with-any-other-apis' title=''>使用其他 APIs 部分</a>。</p>

<p><a href='#working-with-databases'></a></p>
            <h3>
                <a class="header-anchor"
                    name="databases"
                    aria-hidden="true"
                    href="#databases"><i class="fa fa-link"></i></a>
                使用 databases
            </h3>

<p>对于一般资源管理和特别是数据库，bluebird 包括强大的 <a href='/bluebird_cn/docs/api/promise.using.html'><code>Promise.using</code></a>  和处置器（disposers）系统。 这与 Python 中的 <code>with</code>、C＃中的 <code>using</code>、Java 中的 try/resource和C++ 中的 RAII 类似，它使您可以自动处理资源管理。</p>

<p>数据库的几个例子如下：</p>

<blockquote>
<p><strong>注意</strong> 更多的例子请参阅 <a href='/bluebird_cn/docs/api/promise.using.html'><code>Promise.using</code></a> 部分。</p>
</blockquote>
            <h4>
                <a class="header-anchor"
                    name="mongoose"
                    aria-hidden="true"
                    href="#mongoose"><i class="fa fa-link"></i></a>
                Mongoose/MongoDB
            </h4>

<p>Mongoose 使用永久连接工作，驱动器负责重新连接/处置。出于这个原因，使用 <code>using</code> 并不是必需的 —— 而是在服务器启动时连接并使用 promise化 来暴露 promise。</p>

<p>请注意，Mongoose 已经提供了 promise 支持，但它提供的承诺明显较慢，不报告未处理的拒绝，所以无论如何建议使用自动的 promise化：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">Mongoose</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mongoose&quot;</span><span class="p">));</span>
</code></pre></div>            <h4>
                <a class="header-anchor"
                    name="sequelize"
                    aria-hidden="true"
                    href="#sequelize"><i class="fa fa-link"></i></a>
                Sequelize
            </h4>

<p>Sequelize 内部已经使用了 Bluebird 的 promise，并具有返回 promise api。使用它们。</p>
            <h4>
                <a class="header-anchor"
                    name="rethinkdb"
                    aria-hidden="true"
                    href="#rethinkdb"><i class="fa fa-link"></i></a>
                RethinkDB
            </h4>

<p>RethinkDB 内部已经使用了 Bluebird 的 promise，并具有返回 promise api。使用它们。</p>
            <h4>
                <a class="header-anchor"
                    name="bookshelf"
                    aria-hidden="true"
                    href="#bookshelf"><i class="fa fa-link"></i></a>
                Bookshelf
            </h4>

<p>Bookshelf 内部已经使用了 Bluebird 的 promise，并具有返回 promise api。使用它们。</p>
            <h4>
                <a class="header-anchor"
                    name="postgresql"
                    aria-hidden="true"
                    href="#postgresql"><i class="fa fa-link"></i></a>
                PostgreSQL
            </h4>

<p>下面是如何为 PostgreSQL 驱动程序创建一个处置器:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">pg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;pg&quot;</span><span class="p">);</span>
<span class="c1">// Uncomment if pg has not been properly promisified yet.</span>
<span class="c1">//var Promise = require(&quot;bluebird&quot;);</span>
<span class="c1">//Promise.promisifyAll(pg, {</span>
<span class="c1">//    filter: function(methodName) {</span>
<span class="c1">//        return methodName === &quot;connect&quot;</span>
<span class="c1">//    },</span>
<span class="c1">//    multiArgs: true</span>
<span class="c1">//});</span>
<span class="c1">// Promisify rest of pg normally.</span>
<span class="c1">//Promise.promisifyAll(pg);</span>

<span class="kd">function</span> <span class="nx">getSqlConnection</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">close</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pg</span><span class="p">.</span><span class="nx">connectAsync</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">close</span> <span class="o">=</span> <span class="nx">done</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">close</span><span class="p">)</span> <span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">getSqlConnection</span><span class="p">;</span>
</code></pre></div>
<p>Which would allow you to use:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">using</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">using</span><span class="p">;</span>

<span class="nx">using</span><span class="p">(</span><span class="nx">getSqlConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// use connection here and _return the promise_</span>

<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// connection already disposed here</span>

<span class="p">});</span>
</code></pre></div>
<p>也可以为事物管理使用处置器模式 (但不是实际的 .disposer)：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">function</span> <span class="nx">withTransaction</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">using</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">acquireConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">beginTransaction</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">Promise</span>
      <span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">tx</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">commit</span><span class="p">().</span><span class="nx">thenReturn</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">},</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">()</span>
                     <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* maybe add the rollback error to err */</span><span class="p">})</span>
                     <span class="p">.</span><span class="nx">thenThrow</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">withTransaction</span> <span class="o">=</span> <span class="nx">withTransaction</span><span class="p">;</span>
</code></pre></div>
<p>你可以这样做:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nx">withTransaction</span><span class="p">(</span><span class="nx">tx</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...)</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...)</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>            <h4>
                <a class="header-anchor"
                    name="mysql"
                    aria-hidden="true"
                    href="#mysql"><i class="fa fa-link"></i></a>
                MySQL
            </h4>

<p>下面是如何为 MySQL 驱动程序创建一个处置器：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">);</span>
<span class="c1">// 如果 mysql 还没有被正确的 promise化，就取消注释</span>
<span class="c1">// var Promise = require(&quot;bluebird&quot;);</span>
<span class="c1">// Promise.promisifyAll(mysql);</span>
<span class="c1">// Promise.promisifyAll(require(&quot;mysql/lib/Connection&quot;).prototype);</span>
<span class="c1">// Promise.promisifyAll(require(&quot;mysql/lib/Pool&quot;).prototype);</span>
<span class="kd">var</span> <span class="nx">pool</span>  <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
    <span class="nx">connectionLimit</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;example.org&#39;</span><span class="p">,</span>
    <span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;secret&#39;</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getSqlConnection</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnectionAsync</span><span class="p">().</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">getSqlConnection</span><span class="p">;</span>
</code></pre></div>
<p>使用模式类似于上面的 PostgreSQL 示例。您也可以使用 disposer 模式(但不是实际 .disposer)。请参阅上面的 PostgreSQ L示例，以获得指导。</p>

<p><a href='#more-common-examples'></a></p>
            <h3>
                <a class="header-anchor"
                    name=""
                    aria-hidden="true"
                    href="#"><i class="fa fa-link"></i></a>
                更常见的例子
            </h3>

<p>一些将上述实践应用于一些流行的库的例子：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// 最受欢迎的 redis 模块</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// 最受欢迎的 mongodb 模块</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mongodb&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// 最受欢迎的 mysql 模块</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="c1">// Note that the library&#39;s classes are not properties of the main export</span>
<span class="c1">// so we require and promisifyAll them manually</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql/lib/Connection&quot;</span><span class="p">).</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql/lib/Pool&quot;</span><span class="p">).</span><span class="nx">prototype</span><span class="p">);</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// Mongoose</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mongoose&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// Request</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">));</span>
<span class="c1">// Use request.getAsync(...) not request(..), it will not return a promise</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// mkdir</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mkdirp&quot;</span><span class="p">));</span>
<span class="c1">// Use mkdirp.mkdirpAsync not mkdirp(..), it will not return a promise</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// winston</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;winston&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// rimraf</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="c1">// The module isn&#39;t promisified but the function returned is</span>
<span class="kd">var</span> <span class="nx">rimrafAsync</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rimraf&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// xml2js</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;xml2js&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// jsdom</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;jsdom&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// fs-extra</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs-extra&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// prompt</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// Nodemailer</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;nodemailer&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// ncp</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;ncp&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// pg</span>
<span class="kd">var</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;pg&quot;</span><span class="p">));</span>
</code></pre></div>
<p>在上述所有情况下，这个库都以这样或那样的方式使其类可用。如果不是这样，您仍然可以通过创建一个一次性的实例来进行 promise化：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">var</span> <span class="nx">ParanoidLib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">throwAwayInstance</span> <span class="o">=</span> <span class="nx">ParanoidLib</span><span class="p">.</span><span class="nx">createInstance</span><span class="p">();</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">throwAwayInstance</span><span class="p">));</span>
<span class="c1">// Like before, from this point on, all new instances + even the throwAwayInstance suddenly support promises</span>
</code></pre></div>
<p><a href='#working-with-any-other-apis'></a></p>
            <h3>
                <a class="header-anchor"
                    name="api"
                    aria-hidden="true"
                    href="#api"><i class="fa fa-link"></i></a>
                与其他 API 一起工作
            </h3>

<p>有时，您必须使用不一致的 API，而不遵循惯例。</p>

<blockquote>
<p><strong>注意</strong> Promise 返回函数永远不会抛出</p>
</blockquote>

<p>例如，类似:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">function</span> <span class="nx">getUserData</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">onLoad</span><span class="p">,</span> <span class="nx">onFail</span><span class="p">)</span> <span class="p">{</span> <span class="p">...}</span>
</code></pre></div>
<p>我们可以使用 promise 构造函数将其转换为 promise 返回函数:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kd">function</span> <span class="nx">getUserDataAsync</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Put all your code here, this section is throw-safe.</span>
        <span class="nx">getUserData</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
  </article>

</div>

        </div>
      </div>
  </div>
    <footer>
      <div class="container">
        <p style="text-align:center">本站翻译自 <a href='https://github.com/petkaantonov/bluebird/'>bluebird</a></p>
      </div>
    </footer>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="//cdn.jsdelivr.net/bluebird/3.5.1/bluebird.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46253177-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>

</html>
